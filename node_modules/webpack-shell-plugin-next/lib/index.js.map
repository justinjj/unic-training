{"version":3,"file":"index.js","sources":["../src/webpack-shell-plugin-next.js"],"sourcesContent":["const spawn = require('child_process').spawn;\nconst exec = require('child_process').exec;\nconst spawnSync = require('child_process').spawnSync;\nconst execSync = require('child_process').execSync;\nconst os = require('os');\nif (!global._babelPolyfill) {\n  require('babel-polyfill');\n}\n\nconst defaultOptions = {\n  onBuildStart: {\n    scripts: [],\n    blocking: false,\n    parallel: false\n  },\n  onBuildEnd: {\n    scripts: [],\n    blocking: false,\n    parallel: false\n  },\n  onBuildExit: {\n    scripts: [],\n    blocking: false,\n    parallel: false\n  },\n  dev: true,\n  safe: false\n};\n\nexport default class WebpackShellPlugin {\n  constructor(options) {\n    this.options = this.validateInput(this.mergeOptions(options, defaultOptions));\n  }\n\n  putsAsync(resolve) {\n    return (error, stdout, stderr) => {\n      if (error) {\n        throw error;\n      }\n      resolve();\n    }\n  }\n\n  spreadStdoutAndStdErr(proc) {\n    proc.stdout.pipe(process.stdout);\n    proc.stderr.pipe(process.stdout);\n  }\n\n  serializeScript(script) {\n    if (typeof script === 'string') {\n      const [command, ...args] = script.split(' ');\n      return {command, args};\n    }\n    const {command, args} = script;\n    return {command, args};\n  }\n\n  handleScript(script) {\n    if (os.platform() === 'win32' || this.options.safe) {\n      const buffer = execSync(script, {stdio: 'inherit'});\n    } else {\n      const {command, args} = this.serializeScript(script);\n      spawnSync(command, args, {stdio: 'inherit'});\n    }\n  }\n\n  handleScriptAsync(script) {\n    if (os.platform() === 'win32' || this.options.safe) {\n      return new Promise((resolve) => {\n        this.spreadStdoutAndStdErr(exec(script, this.putsAsync(resolve)))\n      });\n    }\n\n    const {command, args} = this.serializeScript(script);\n    const proc = spawn(command, args, {stdio: 'inherit'});\n    return new Promise((resolve) => proc.on('close', this.putsAsync(resolve)));\n  }\n\n  async executeScripts(scripts, parallel, blocking) {\n    if (!scripts || scripts.length <= 0) {\n      return;\n    }\n\n    if (blocking && !parallel) {\n      for (let i = 0; i < scripts.length; i++) {\n        this.handleScript(scripts[i]);\n      }\n    }\n    else if (!blocking && !parallel) {\n      for (let i = 0; i < scripts.length; i++) {\n        await this.handleScriptAsync(scripts[i]);\n      }\n    }\n    else if (blocking && parallel) {\n      throw new Exception(\"Not supported\");\n    }\n    else if (!blocking && parallel) {\n      for (let i = 0; i < scripts.length; i++) {\n        this.handleScriptAsync(scripts[i], blocking);\n      }\n    }\n  }\n\n  validateInput(options) {\n    if (typeof options.onBuildStart === 'string') {\n      options.onBuildStart.scripts = options.onBuildStart.split('&&');\n    }\n    if (typeof options.onBuildEnd === 'string') {\n      options.onBuildEnd.scripts = options.onBuildEnd.split('&&');\n    }\n    if (typeof options.onBuildExit === 'string') {\n      options.onBuildExit.scripts = options.onBuildExit.split('&&');\n    }\n    return options;\n  }\n\n  mergeOptions(options, defaults) {\n    for (const key in defaults) {\n      if (options.hasOwnProperty(key)) {\n        defaults[key] = options[key];\n      }\n    }\n    return defaults;\n  }\n\n  \n  apply(compiler) {\n    compiler.hooks.compilation.tap('webpack-shell-plugin-next', (compilation) => {\n      const onBuildStartOption = this.options.onBuildStart;\n      if (this.options.verbose) {\n        console.log(`Report compilation: ${compilation}`);\n        console.warn(`WebpackShellPlugin [${new Date()}]: Verbose is being deprecated, please remove.`);\n      }\n      if (onBuildStartOption.scripts && onBuildStartOption.scripts.length > 0) {\n        console.log('Executing pre-build scripts');\n        this.executeScripts(onBuildStartOption.scripts, onBuildStartOption.parallel, onBuildStartOption.blocking);\n\n        if (this.options.dev) {\n          this.options.onBuildStart = [];\n        }\n      }\n    });\n\n    compiler.hooks.afterEmit.tapAsync('webpack-shell-plugin-next', (compilation, callback) => {\n      const onBuildEndOption = this.options.onBuildEnd;\n      if (onBuildEndOption.scripts && onBuildEndOption.scripts.length > 0) {\n        console.log('Executing post-build scripts');\n        this.executeScripts(onBuildEndOption.scripts, onBuildEndOption.parallel, onBuildEndOption.blocking);\n        if (this.options.dev) {\n          this.options.onBuildEnd = [];\n        }\n      }\n      callback();\n    });\n\n    compiler.hooks.done.tap('webpack-shell-plugin-next', () => {\n      const onBuildExitOption = this.options.onBuildExit;\n      if (onBuildExitOption.scripts && onBuildExitOption.scripts.length > 0) {\n        console.log('Executing additional scripts before exit');\n        this.executeScripts(onBuildExitOption.scripts, onBuildExitOption.parallel, onBuildExitOption.blocking);\n      }\n    });\n  }\n}\n"],"names":["spawn","require","exec","spawnSync","execSync","os","global","_babelPolyfill","defaultOptions","WebpackShellPlugin","options","validateInput","mergeOptions","resolve","error","stdout","stderr","proc","pipe","process","script","split","command","args","platform","safe","buffer","stdio","serializeScript","Promise","spreadStdoutAndStdErr","putsAsync","on","scripts","parallel","blocking","length","i","handleScript","handleScriptAsync","Exception","onBuildStart","onBuildEnd","onBuildExit","defaults","key","hasOwnProperty","compiler","hooks","compilation","tap","onBuildStartOption","verbose","log","warn","Date","executeScripts","dev","afterEmit","tapAsync","callback","onBuildEndOption","done","onBuildExitOption"],"mappings":"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"}